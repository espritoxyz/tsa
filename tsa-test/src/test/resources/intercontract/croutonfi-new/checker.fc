#include "../../imports/stdlib.fc";
#include "../../imports/tsa_functions.fc";

global slice initial_sender;
global int initial_value;

() on_internal_message_send(cell msg_full, slice msg_body, int input_id) impure method_id {
    tsa_forbid_failures();

    slice cs = msg_full.begin_parse();
    cs~skip_bits(4); ;; message headers
    slice src = cs~load_msg_addr();

    tsa_assert(equal_slice_bits(src, initial_sender));

    cs~load_msg_addr(); ;; dest address

    int value = cs~load_grams();
    initial_value = value;

    int opcode = msg_body~load_uint(32);
    tsa_assert(opcode == 0x25938561);

    tsa_allow_failures();
}

() on_out_message(cell msg_full, slice msg_body, int receiver_contract_id, int sender_contract_id) impure method_id {
    slice cs = msg_full.begin_parse();
    cs~skip_bits(4); ;; message headers
    cs~load_msg_addr(); ;; src address
    slice dest = cs~load_msg_addr();
    int value = cs~load_grams();

    if (equal_slice_bits(dest, initial_sender)) {
        tsa_fetch_value(initial_value, -1);
        tsa_fetch_value(value, -2);

        throw_if(1000, value > initial_value);
    }
}

() main() impure {
    ;; just some address
    initial_sender = "UQALzO3OsJXu5WH5PvDCTxmlGW1rthvmVxQK-Hrt94UHroqu"a;

    tsa_send_internal_message(1, 0);
}
