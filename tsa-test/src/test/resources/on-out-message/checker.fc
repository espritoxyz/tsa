#include "../imports/stdlib.fc";
#include "../imports/tsa_functions.fc";

global int flag_in;

() on_internal_message_send(int balance, int msg_value, cell in_msg_full, slice msg_body, int input_id) impure method_id {
    tsa_forbid_failures();
    tsa_assert(msg_value == 10000000000);

    int op = msg_body~load_uint(32);
    if (input_id == 0) {
        tsa_assert(op == 100);
    } elseif (input_id == 1) {
        tsa_assert(op == 200);
    } elseif (input_id == 2) {
        tsa_assert(op == 300);
    } elseif (input_id == 3) {
        tsa_assert(op == 400);
    } elseif (input_id == 4) {
        tsa_assert(op == 500);
    } elseif (input_id == 5) {
        tsa_assert(op == 600);
    }
    tsa_allow_failures();
}

() on_out_message(cell msg_full, slice msg_body, int receiver_contract_id, int sender_contract_id) impure method_id {
    ;; load written forward fee
    slice cs = msg_full.begin_parse();
    cs~skip_bits(2); ;; magic number + ihr_disabled
    int bounceable = cs~load_uint(1);
    cs~skip_bits(1); ;; bounced field
    cs~load_msg_addr(); ;; src address
    cs~load_msg_addr(); ;; dest address
    int value = cs~load_grams(); ;; value
    cs~skip_bits(1 + 4 + 4 + 64 + 32); ;; skip other default message headers

    if (flag_in == 0) {
        ;; read everything
        int is_there_state_init? = cs~load_uint(1);
        int state_init_as_ref? = cs~load_uint(1);
        cs~load_uint(3); ;; first integer in StateInit
        cs~load_uint(1); ;; second integer in StateInit
        cs~load_uint(1); ;; third integer in StateInit
        cs~load_ref(); ;; code cell in StateInit
        cs~load_ref(); ;; data cell in StateInit
        int body_as_ref? = cs~load_uint(1);
        int number_in_body = cs~load_uint(10);
        cell ref_in_body = cs~load_ref();

        ;; forming the read body
        slice body_formed = begin_cell()
            .store_uint(number_in_body, 10)
            .store_ref(ref_in_body)
            .end_cell()
            .begin_parse();

        ;; check everything
        throw_unless(200, bounceable == 0);
        throw_unless(201, value == 1000000000);
        throw_unless(202, is_there_state_init? == 1);
        throw_unless(203, state_init_as_ref? == 0);
        throw_unless(204, body_as_ref? == 0);
        throw_unless(205, body_formed.slice_hash() == msg_body.slice_hash());
        throw_unless(206, cs.slice_empty?() == 1);
    } elseif (flag_in == 1) {
        ;; read everything
        int is_there_state_init? = cs~load_uint(1);
        int state_init_as_ref? = cs~load_uint(1);
        cs~load_ref(); ;; StateInit
        int body_as_ref? = cs~load_uint(1);
        int number_in_body = cs~load_uint(10);
        cell ref_in_body = cs~load_ref();

        ;; forming the read body
        slice body_formed = begin_cell()
            .store_uint(number_in_body, 10)
            .store_ref(ref_in_body)
            .end_cell()
            .begin_parse();

        ;; check everything
        throw_unless(300, bounceable == 1);
        throw_unless(301, value == 1500000000);
        throw_unless(302, is_there_state_init? == 1);
        throw_unless(303, state_init_as_ref? == 1);
        throw_unless(304, body_as_ref? == 0);
        throw_unless(305, body_formed.slice_hash() == msg_body.slice_hash());
        throw_unless(306, cs.slice_empty?() == 1);
    } elseif (flag_in == 2) {
        ;; read everything
        int is_there_state_init? = cs~load_uint(1);
        int state_init_as_ref? = cs~load_uint(1);
        cs~load_uint(3); ;; first integer in StateInit
        cs~load_uint(1); ;; second integer in StateInit
        cs~load_uint(1); ;; third integer in StateInit
        cs~load_ref(); ;; code cell in StateInit
        cs~load_ref(); ;; data cell in StateInit
        int body_as_ref? = cs~load_uint(1);
        slice body_formed = cs~load_ref().begin_parse();

        ;; check everything
        throw_unless(400, bounceable == 0);
        throw_unless(401, value == 2000000000);
        throw_unless(402, is_there_state_init? == 1);
        throw_unless(403, state_init_as_ref? == 0);
        throw_unless(404, body_as_ref? == 1);
        throw_unless(405, body_formed.slice_hash() == msg_body.slice_hash());
        throw_unless(406, cs.slice_empty?() == 1);
    } elseif (flag_in == 3) {
        ;; read everything
        int is_there_state_init? = cs~load_uint(1);
        int state_init_as_ref? = cs~load_uint(1);
        cs~load_ref(); ;; StateInit
        int body_as_ref? = cs~load_uint(1);
        slice body_formed = cs~load_ref().begin_parse();

        ;; check everything
        throw_unless(500, bounceable == 0);
        throw_unless(501, value == 3000000000);
        throw_unless(502, is_there_state_init? == 1);
        throw_unless(503, state_init_as_ref? == 1);
        throw_unless(504, body_as_ref? == 1);
        throw_unless(505, body_formed.slice_hash() == msg_body.slice_hash());
        throw_unless(506, cs.slice_empty?() == 1);
    } elseif (flag_in == 4) {
        ;; read everything
        int is_there_state_init? = cs~load_uint(1);
        int body_as_ref? = cs~load_uint(1);
        int number_in_body = cs~load_uint(10);
        cell ref_in_body = cs~load_ref();

        ;; forming the read body
        slice body_formed = begin_cell()
            .store_uint(number_in_body, 10)
            .store_ref(ref_in_body)
            .end_cell()
            .begin_parse();

        ;; check everything
        throw_unless(600, bounceable == 0);
        throw_unless(601, value == 3000000000);
        throw_unless(602, is_there_state_init? == 0);
        throw_unless(604, body_as_ref? == 0);
        throw_unless(605, body_formed.slice_hash() == msg_body.slice_hash());
        throw_unless(606, cs.slice_empty?() == 1);
    } elseif (flag_in == 5) {
        ;; read everything
        int is_there_state_init? = cs~load_uint(1);
        int body_as_ref? = cs~load_uint(1);
        slice body_formed = cs~load_ref().begin_parse();

        ;; check everything
        throw_unless(700, bounceable == 0);
        throw_unless(701, value == 4800000000);
        throw_unless(702, is_there_state_init? == 0);
        throw_unless(704, body_as_ref? == 1);
        throw_unless(705, body_formed.slice_hash() == msg_body.slice_hash());
        throw_unless(706, cs.slice_empty?() == 1);
    }
} 

() main() impure {
    ;; set sender's balance to zero
    tsa_forbid_failures();
    int sender_balance = tsa_get_balance(1);
    tsa_assert(sender_balance == 0);
    tsa_allow_failures();

    flag_in = get_data().begin_parse().preload_int(64);
    tsa_send_internal_message(1, flag_in);

    throw(10000); ;; success
}
