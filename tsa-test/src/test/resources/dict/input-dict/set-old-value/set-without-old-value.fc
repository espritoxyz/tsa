#include "../util.fc";
#include "../../../imports/stdlib.fc";

const int c::key = 13;
const int c::init_value = 100;
const int c::new_value = 200;

() test(slice in_msg) impure method_id (1) {
    cell init_dict = in_msg~load_dict();
    (slice init_value, int found) = init_dict.udict_get?(64, c::key);
    throw_unless(300, ~ found);

    (cell newdict, slice old_value, int has_old_key) = udict_set_get(init_dict, 64, c::key, wrap_in_cell(c::new_value));
    throw_unless(400, ~ has_old_key);

    (slice new_value, int found) = newdict.udict_get?(64, c::key);
    throw_unless(410, found);
    throw_unless(411, new_value.preload_int(64) == c::new_value);

    throw(500);
}


() main(slice in_msg) {
    test(in_msg);
    return ();
}
