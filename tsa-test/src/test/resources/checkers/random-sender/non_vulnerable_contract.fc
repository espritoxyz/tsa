#include "../../imports/stdlib.fc";

const int op::withdraw = 0x12345678;
const int op::payment = 0x87654321;

const int err:unauthorized = 700;

slice get_owner() impure method_id {
    slice ds = get_data().begin_parse();
    return ds~load_msg_addr();
}

() recv_internal(cell full_msg, slice msg_body) {
    slice cs = full_msg.begin_parse();
    int flags = cs~load_uint(4);

    ;; process bounced message
    if (flags & 1) {
        return ();
    }

    slice sender = cs~load_msg_addr();
    slice owner = get_owner();
    throw_unless(err:unauthorized, equal_slice_bits(sender, owner));

    int opcode = msg_body~load_uint(32);
    if (opcode == op::withdraw) {
        cell msg = begin_cell()
            .store_uint(0x10, 6)
            .store_slice(sender)
            .store_coins(0)
            .store_uint(0, 1 + 4 + 4 + 64 + 32 + 1 + 1) ;; default message headers
            .store_uint(op::payment, 32)
            .end_cell();

        send_raw_message(msg, 128);
    }
}
