#include "../../imports/stdlib.fc";
#include "../../imports/tsa_functions.fc";

global int on_out_message_zero;
global int on_out_message_one;

() on_out_message(int contract_message_number, cell msg_full, slice msg_body, int receiver_contract_id, int sender_contract_id) impure method_id {
    throw_unless(400, sender_contract_id == 1);
    if (contract_message_number == 0) {
        on_out_message_zero += 1;
    } elseif  (contract_message_number == 1) {
        on_out_message_one  += 1;
    }
}

() on_internal_message_send(int balance, int msg_value, cell in_msg_full, slice msg_body, int input_id) impure method_id {
    tsa_forbid_failures();

    slice cs = in_msg_full.begin_parse();
    int flags = cs~load_uint(4);
    tsa_assert_not(flags & 1);
    int op = msg_body~load_uint(32);
    tsa_assert(op == input_id);
    tsa_allow_failures();
}

() main() impure {
    on_out_message_zero = 0;
    on_out_message_one = 0;
    tsa_send_internal_message(1, 100);
    tsa_send_internal_message(1, 200);
    throw_unless(410, on_out_message_zero == 2);
    throw_unless(420, on_out_message_one == 2);
    throw(500);
}
