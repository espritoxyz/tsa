"../fiftstdlib/Fift.fif" include
"../fiftstdlib/Asm.fif" include

PROGRAM{
  0  DECLMETHOD store_std_addr
  1  DECLMETHOD store_std_addr_with_anycast
  2  DECLMETHOD store_std_addr_too_short
  3  DECLMETHOD store_std_addr_too_long
  4  DECLMETHOD store_std_addr_bad_tag
  5  DECLMETHOD load_std_addr
  6  DECLMETHOD load_std_addr_too_short
  7  DECLMETHOD load_std_addr_bad_tag
  8  DECLMETHOD store_std_addr_from_none
  9  DECLMETHOD load_std_addr_from_none
  10 DECLMETHOD ld_opt_std_addr
  11 DECLMETHOD ld_opt_std_addr_none
  12 DECLMETHOD ld_opt_std_addr_empty

  store_std_addr PROC:<{
    NEWC
    2 PUSHINT // = 0b10, std prefix
    2 STUR
    0 PUSHINT // = no anycast
    1 STUR
    0 PUSHINT // = workchain id
    8 STUR
    0 PUSHINT
    256 STUR
    ENDC
    CTOS // stack is [std-addr-slice]
    NEWC
    STSTDADDR
    ENDC
    HASHCU
  }>

  store_std_addr_with_anycast PROC:<{
    NEWC
    2 PUSHINT // = 0b10, std prefix
    2 STUR
    1 PUSHINT // = no anycast
    1 STUR
    0 PUSHINT // = workchain id
    8 STUR
    0 PUSHINT
    256 STUR
    ENDC
    CTOS // stack is [std-addr-slice]
    NEWC
    STSTDADDR
    ENDC
    HASHCU
  }>

  store_std_addr_too_short PROC:<{
  NEWC
    2 PUSHINT // = 0b10, std prefix
    2 STUR
    1 PUSHINT // = no anycast
    1 STUR
    0 PUSHINT // = workchain id
    8 STUR
    0 PUSHINT
    100 STUR // too short
    ENDC
    CTOS // stack is [std-addr-slice]
    NEWC
    STSTDADDR
    ENDC
    HASHCU
  }>


  store_std_addr_too_long PROC:<{
  NEWC
    2 PUSHINT // = 0b10, std prefix
    2 STUR
    1 PUSHINT // = no anycast
    1 STUR
    0 PUSHINT // = workchain id
    8 STUR
    0 PUSHINT
    256 STUR
    0 PUSHINT
    4 STUR // now the slice is too long
    ENDC
    CTOS // stack is [std-addr-slice]
    NEWC
    STSTDADDR
    ENDC
    HASHCU
  }>

  store_std_addr_bad_tag PROC:<{
    NEWC
    0 PUSHINT // = 0b00, none address prefix
    2 STUR
    1 PUSHINT // = no anycast
    1 STUR
    0 PUSHINT // = workchain id
    8 STUR
    0 PUSHINT
    256 STUR
    0 PUSHINT
    4 STUR // now the slice is too long
    ENDC // stack is [std-addr-slice]
    NEWC
    STSTDADDR
    ENDC
    HASHCU
  }>

  load_std_addr PROC:<{
    NEWC
    2 PUSHINT
    2 STUR
    0 PUSHINT
    1 STUR
    0 PUSHINT
    8 STUR
    0 PUSHINT
    256 STUR
    ENDC
    CTOS
    LDSTDADDR
    DROP
    HASHCU
  }>


  load_std_addr_too_short PROC:<{
    NEWC
    2 PUSHINT
    2 STUR
    0 PUSHINT
    1 STUR
    0 PUSHINT
    8 STUR
    0 PUSHINT
    100 STUR
    ENDC
    CTOS
    LDSTDADDR
    DROP
    HASHCU
  }>

  load_std_addr_bad_tag PROC:<{
    NEWC
    0 PUSHINT
    2 STUR
    0 PUSHINT
    1 STUR
    0 PUSHINT
    8 STUR
    0 PUSHINT
    256 STUR
    ENDC
    CTOS
    LDSTDADDR
    DROP
    HASHCU
  }>

  store_std_addr_from_none PROC:<{
    NEWC
    2 PUSHINT // = 0b10, std prefix
    2 STUR
    ENDC
    CTOS // stack is [std-addr-slice]
    NEWC
    STSTDADDR
    ENDC
    HASHCU
  }>

  load_std_addr_from_none PROC:<{
    NEWC
    0 PUSHINT
    2 STUR
    ENDC
    CTOS
    LDSTDADDR
    DROP
    HASHCU
  }>

  ld_opt_std_addr PROC:<{
    NEWC
    2 PUSHINT
    2 STUR
    0 PUSHINT
    1 STUR
    0 PUSHINT
    8 STUR
    0 PUSHINT
    256 STUR
    ENDC
    CTOS
    LDOPTSTDADDR
    DROP
    HASHCU
  }>

  ld_opt_std_addr_none PROC:<{
    NEWC
    0 PUSHINT
    2 STUR
    ENDC
    CTOS
    LDOPTSTDADDR
    DROP
    ISNULL
  }>

  ld_opt_std_addr_empty PROC:<{
    NEWC
    ENDC
    CTOS
    LDOPTSTDADDR
    DROP
    ISNULL
  }>
}END>c
